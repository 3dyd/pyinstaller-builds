name: build
on:
  workflow_dispatch:
    inputs:
      version:
        default: 6.16.0
        type: string

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    name: build
    runs-on: windows-2025
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Set up MinGW
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: MINGW32
          install: >-
            base-devel
            mingw-w64-i686-toolchain
            mingw-w64-i686-python
            mingw-w64-i686-python-pip

      - name: Prepare environment
        run: |
          python -m pip install --upgrade pip hatchling
          mkdir _site

      - name: Checkout for Vista
        uses: actions/checkout@v4
        with:
          repository: pyinstaller/pyinstaller
          ref: v${{ inputs.version }}
          path: vista

      - name: Build for Vista
        run: |
          cd vista/bootloader
          CFLAGS=-DPSAPI_VERSION=1 LDFLAGS=-lpsapi python waf all --target-arch=32bit --gcc
          cd ..
          python -m hatchling build
          mv dist ../_site/vista

      - name: Checkout for XP
        uses: actions/checkout@v4
        with:
          repository: 3dyd/pyinstaller
          ref: ${{ inputs.version }}-xp
          path: xp

      - name: Build for XP
        run: |
          cd xp/bootloader
          python waf all --target-arch=32bit --gcc
          cd ..
          python -m hatchling build
          mv dist ../_site/xp

      - name: Generate index.html
        run: |
          cd _site
          li() {
            ls $1 | while read l; do
              echo "<li><a href="$1/$l">$l</a> ($(du -b $1/$l | awk '{printf "%.2f", $1/2^20}')MB)</li>"
            done
          }
          cat <<EOF > index.html
          <!DOCTYPE html>
          <html>
          <body>
          <p>Vista:</p>
          <ul>
          $(li vista)
          </ul>
          <p>XP:</p>
          <ul>
          $(li xp)
          </ul>
          <p>$(date --utc)</p>
          </body>
          EOF

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
